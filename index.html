<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OmniTavern v3 - 多重身份版</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-glass: rgba(20, 20, 25, 0.95);
            --bg-glass-light: rgba(255, 255, 255, 0.08);
            --primary: #7aa2f7;
            --danger: #f7768e;
            --text: #c0caf5;
            --border: rgba(255, 255, 255, 0.15);
            --bubble-user: #2d3f50;
            --bubble-char: #1f2335;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1b26; color: var(--text); height: 100vh; overflow: hidden; background-size: cover; background-position: center; transition: background 0.3s; }

        #app { display: flex; height: 100%; width: 100%; position: relative; }
        
        /* 侧边栏 */
        .sidebar { width: 300px; background: var(--bg-glass); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 100; transition: transform 0.3s; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border); font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        .nav-tabs { display: flex; background: rgba(0,0,0,0.3); }
        .nav-item { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; color: #888; }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); background: var(--bg-glass-light); }
        .tab-content { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .tab-content.active { display: block; }

        /* 控件 */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.75rem; color: #aaa; margin-bottom: 5px; }
        .form-control { width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 16px; }
        
        select.form-control { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 1em; }

        .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; gap: 5px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-ghost { background: transparent; color: #aaa; width: auto; padding: 5px; }
        
        .list-item { display: flex; padding: 10px; margin-bottom: 8px; background: var(--bg-glass-light); border-radius: 8px; cursor: pointer; border: 1px solid transparent; align-items: center; gap: 10px; position: relative; }
        .list-item.active { border-color: var(--primary); background: rgba(122, 162, 247, 0.15); }
        .avatar-sm { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; background: #333; flex-shrink: 0; }
        
        /* 玩家身份标签 */
        .persona-tag { font-size: 0.7rem; background: var(--primary); color: #000; padding: 2px 6px; border-radius: 4px; position: absolute; top: 5px; right: 5px; display: none; }
        .list-item.active .persona-tag { display: block; }

        /* 主界面 */
        .main-stage { flex: 1; display: flex; flex-direction: column; position: relative; background: rgba(0,0,0,0.2); }
        .top-bar { height: 50px; padding: 0 10px; background: var(--bg-glass); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        
        .timeline-controls { display: flex; align-items: center; gap: 8px; flex: 1; overflow: hidden; }
        #sessionSelect { flex: 1; max-width: 160px; height: 32px; padding: 0 5px; font-size: 0.8rem; border: 1px solid var(--border); border-radius: 4px; background: rgba(0,0,0,0.3); color: white; }

        /* 聊天区 */
        .chat-container { flex: 1; padding: 15px; overflow-y: auto; scroll-behavior: smooth; }
        .msg-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .msg-row.user { flex-direction: row-reverse; }
        .msg-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        
        .msg-body { max-width: 85%; display: flex; flex-direction: column; }
        .msg-row.user .msg-body { align-items: flex-end; }
        .msg-bubble { padding: 10px 14px; border-radius: 12px; line-height: 1.5; word-wrap: break-word; font-size: 0.95rem; }
        .msg-row.user .msg-bubble { background: var(--bubble-user); color: white; border-top-right-radius: 2px; }
        .msg-row.char .msg-bubble { background: var(--bubble-char); color: #ddd; border-top-left-radius: 2px; }
        .msg-bubble p { margin: 5px 0; }
        
        .msg-meta { font-size: 0.65rem; color: #666; margin-top: 4px; display: flex; gap: 8px; }

        /* 底部输入 */
        .input-area { padding: 10px; background: var(--bg-glass); border-top: 1px solid var(--border); }
        .input-wrapper { display: flex; gap: 8px; background: rgba(0,0,0,0.4); border-radius: 8px; padding: 8px; border: 1px solid var(--border); }
        textarea#userInput { flex: 1; background: transparent; border: none; color: white; resize: none; height: 40px; max-height: 120px; font-size: 16px; }
        .send-btn { width: 40px; height: 40px; border-radius: 6px; background: var(--primary); border: none; color: white; font-size: 1.1rem; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; display: none; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #1f2335; width: 90%; max-width: 400px; max-height: 90vh; border-radius: 12px; padding: 20px; overflow-y: auto; border: 1px solid var(--border); }

        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .overlay.active { display: block; }
        }
    </style>
</head>
<body>

<div id="app">
    <div class="overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span>OmniTavern v3</span>
            <button class="btn-ghost" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>

        <div class="nav-tabs">
            <div class="nav-item active" onclick="switchTab('chars')">角色</div>
            <div class="nav-item" onclick="switchTab('user')">玩家(身份)</div>
            <div class="nav-item" onclick="switchTab('settings')">设置</div>
        </div>

        <div id="tab-chars" class="tab-content active">
            <button class="btn btn-primary" onclick="openCharEditor()"><i class="fas fa-plus"></i> 新建角色</button>
            <div id="charList" style="margin-top: 15px;"></div>
        </div>

        <div id="tab-user" class="tab-content">
            <button class="btn btn-primary" onclick="createNewUserPersona()"><i class="fas fa-user-plus"></i> 新建身份</button>
            <div style="font-size:0.75rem; color:#888; margin: 10px 0;">点击下方列表切换当前使用的身份：</div>
            
            <div id="userPersonaList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;"></div>
            
            <hr style="border-color: #333; margin-bottom: 15px;">
            
            <div id="userEditArea" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span style="font-size:0.8rem; font-weight:bold; color:var(--primary);">正在编辑当前身份</span>
                    <i class="fas fa-trash-alt" style="color:var(--danger); cursor:pointer;" onclick="deleteUserPersona()"></i>
                </div>
                <div class="form-group"><label class="form-label">身份名称</label><input type="text" id="userName" class="form-control" onchange="saveCurrentUser()"></div>
                <div class="form-group"><label class="form-label">头像 URL</label><input type="text" id="userAvatar" class="form-control" onchange="saveCurrentUser()"></div>
                <div class="form-group"><label class="form-label">人设描述 (Persona)</label><textarea id="userDesc" class="form-control" style="height: 100px;" placeholder="我是谁，我的性格，我与对方的关系..." onchange="saveCurrentUser()"></textarea></div>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="form-group"><label class="form-label">API Host</label><input type="text" id="apiHost" class="form-control"></div>
            <div class="form-group"><label class="form-label">API Key</label><input type="password" id="apiKey" class="form-control"></div>
            
            <div class="form-group">
                <label class="form-label">模型 (Model)</label>
                <div style="display:flex; gap:5px;">
                    <select id="modelSelect" class="form-control" onchange="handleModelChange()">
                        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                        <option value="gpt-4o">gpt-4o</option>
                        <option value="deepseek-chat">deepseek-chat</option>
                        <option value="custom">-- 自定义 --</option>
                    </select>
                    <button class="btn btn-primary" style="width:50px;" onclick="fetchModels()"><i class="fas fa-sync"></i></button>
                </div>
                <input type="text" id="customModelInput" class="form-control" style="display:none; margin-top:5px;" placeholder="输入模型名称..." onchange="saveSettings()">
            </div>

            <div class="form-group">
                <label class="form-label">温度: <span id="tempDisplay">0.8</span></label>
                <input type="range" id="temperature" class="form-control" min="0" max="2" step="0.1" value="0.8" style="padding:0;" oninput="document.getElementById('tempDisplay').innerText=this.value; saveSettings()">
            </div>

            <div class="form-group" style="display:flex; justify-content:space-between; align-items:center;">
                <label class="form-label">流式输出</label>
                <input type="checkbox" id="streamToggle" checked onchange="saveSettings()" style="width:20px; height:20px;">
            </div>

            <div class="form-group">
                <label class="form-label">背景 URL</label>
                <input type="text" id="bgUrl" class="form-control" onchange="updateBg()">
            </div>
            
            <button class="btn btn-danger" onclick="nukeData()" style="margin-top:20px;">清空所有数据</button>
        </div>
    </aside>

    <main class="main-stage">
        <div class="top-bar">
            <button class="btn-ghost" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <div class="timeline-controls" id="topControls" style="display:none;">
                <select id="sessionSelect" onchange="switchSession(this.value)"></select>
                <button class="btn-ghost" onclick="createNewSession()" title="新剧情"><i class="fas fa-plus"></i></button>
                <button class="btn-ghost" onclick="forkSession()" title="分支"><i class="fas fa-code-branch"></i></button>
                <button class="btn-ghost" style="color:#f7768e;" onclick="deleteCurrentSession()" title="删除剧情"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div style="text-align:center; margin-top:50px; color:#666;">请选择或创建角色</div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="userInput" placeholder="输入..." onkeydown="handleEnter(event)"></textarea>
                <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
            <button id="stopBtn" class="btn btn-danger" style="display:none; margin-top:5px; padding:5px;" onclick="stopGen()">停止生成</button>
        </div>
    </main>

    <div class="modal" id="charModal">
        <div class="modal-content">
            <h3>编辑角色</h3>
            <input type="hidden" id="editId">
            <div class="form-group"><label class="form-label">名字</label><input type="text" id="editName" class="form-control"></div>
            <div class="form-group"><label class="form-label">头像 URL</label><input type="text" id="editAvatar" class="form-control"></div>
            <div class="form-group"><label class="form-label">人设 (Description)</label><textarea id="editDesc" class="form-control" style="height:80px;"></textarea></div>
            <div class="form-group"><label class="form-label">世界观 (World)</label><textarea id="editWorld" class="form-control" style="height:60px;"></textarea></div>
            <div class="form-group"><label class="form-label">开场白</label><textarea id="editFirst" class="form-control"></textarea></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn btn-primary" onclick="saveChar()">保存</button>
                <button class="btn btn-ghost" onclick="closeModal()">取消</button>
                <button class="btn btn-danger" onclick="deleteChar()">删除角色</button>
            </div>
        </div>
    </div>
</div>

<script>
    const DB_KEY = 'omni_ultimate_v3'; // 升级Key避免冲突
    const DEF_AVATAR = 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
    const DEF_USER_AVATAR = 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
    
    let appData = {
        chars: [], 
        chats: {}, 
        // 核心升级: 支持多重身份
        user_personas: [], // [{id, name, avatar, desc}]
        active_user_id: null,
        settings: { apiHost: "https://api.openai.com/v1", apiKey: "", model: "gpt-4o", temp: 0.8, stream: true, bgUrl: "" }
    };
    let activeCharId = null, activeSessionId = null, abortCtrl = null;

    window.onload = function() {
        // 数据迁移逻辑：尝试读取V2数据
        const v2Data = localStorage.getItem('omni_ultimate_v2');
        if(!localStorage.getItem(DB_KEY) && v2Data) {
            const old = JSON.parse(v2Data);
            appData.chars = old.chars || [];
            appData.chats = old.chats || {};
            appData.settings = old.settings || appData.settings;
            // 迁移旧用户为第一个身份
            const firstId = Date.now().toString();
            appData.user_personas = [{id: firstId, name: old.user.name, avatar: old.user.avatar, desc: old.user.desc}];
            appData.active_user_id = firstId;
            saveData();
        } else {
            loadData();
        }

        // 初始化默认身份
        if(appData.user_personas.length === 0) {
            createNewUserPersona(false);
        }

        renderCharList();
        renderUserList();
        updateBg();
        document.querySelectorAll('#tab-settings input').forEach(el => el.addEventListener('change', saveSettings));
    };

    /* --- 用户身份系统 (Persona System) --- */
    function renderUserList() {
        const list = document.getElementById('userPersonaList');
        list.innerHTML = '';
        appData.user_personas.forEach(p => {
            const div = document.createElement('div');
            div.className = `list-item ${p.id === appData.active_user_id ? 'active' : ''}`;
            div.onclick = () => switchUserPersona(p.id);
            div.innerHTML = `
                <img src="${p.avatar||DEF_USER_AVATAR}" class="avatar-sm">
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:0.9rem;">${p.name}</div>
                    <div style="font-size:0.75rem; color:#888; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; width:150px;">${p.desc}</div>
                </div>
                <span class="persona-tag">当前使用</span>
            `;
            list.appendChild(div);
        });
        
        // 填充编辑区
        const current = appData.user_personas.find(p => p.id === appData.active_user_id);
        if(current) {
            document.getElementById('userEditArea').style.display = 'block';
            document.getElementById('userName').value = current.name;
            document.getElementById('userAvatar').value = current.avatar;
            document.getElementById('userDesc').value = current.desc;
        }
    }

    function createNewUserPersona(render = true) {
        const newId = Date.now().toString();
        const newP = {
            id: newId,
            name: "新身份 " + new Date().toLocaleTimeString().slice(0,5),
            avatar: "",
            desc: ""
        };
        appData.user_personas.push(newP);
        appData.active_user_id = newId;
        saveData();
        if(render) renderUserList();
    }

    function switchUserPersona(id) {
        appData.active_user_id = id;
        saveData();
        renderUserList();
        renderChatUI(); // 刷新聊天界面里的头像
    }

    function saveCurrentUser() {
        const current = appData.user_personas.find(p => p.id === appData.active_user_id);
        if(!current) return;
        current.name = document.getElementById('userName').value;
        current.avatar = document.getElementById('userAvatar').value;
        current.desc = document.getElementById('userDesc').value;
        saveData();
        renderUserList();
        renderChatUI();
    }

    function deleteUserPersona() {
        if(appData.user_personas.length <= 1) return alert("至少保留一个身份");
        if(!confirm("删除此身份？")) return;
        appData.user_personas = appData.user_personas.filter(p => p.id !== appData.active_user_id);
        appData.active_user_id = appData.user_personas[0].id;
        saveData();
        renderUserList();
    }

    function getCurrentUser() {
        return appData.user_personas.find(p => p.id === appData.active_user_id) || {name:"User", avatar:"", desc:""};
    }

    /* --- 核心逻辑 --- */
    function getCharData(cid) {
        if (!appData.chats[cid]) appData.chats[cid] = { sessions: {}, currentSessionId: null };
        return appData.chats[cid];
    }

    function switchSession(sid) {
        if (!activeCharId) return;
        const cData = getCharData(activeCharId);
        if(!cData.sessions[sid]) sid = createNewSession(activeCharId, false);
        activeSessionId = sid;
        cData.currentSessionId = sid;
        saveData();
        renderSessionSelect();
        renderChatUI();
    }

    function createNewSession(charId = activeCharId, switchNow = true) {
        if(!charId) return;
        const cData = getCharData(charId);
        const char = appData.chars.find(c => c.id === charId);
        const newId = Date.now().toString();
        cData.sessions[newId] = {
            id: newId,
            name: "新对话 " + new Date().toLocaleTimeString().slice(0,5),
            messages: char.firstMsg ? [{role:'assistant', content:char.firstMsg, meta:{time:Date.now()}}] : []
        };
        if(switchNow) switchSession(newId);
        return newId;
    }

    function deleteCurrentSession() {
        if(!activeCharId || !activeSessionId) return;
        if(!confirm("删除当前对话？")) return;
        const cData = getCharData(activeCharId);
        delete cData.sessions[activeSessionId];
        const remaining = Object.keys(cData.sessions);
        if(remaining.length > 0) switchSession(remaining[0]);
        else createNewSession();
        saveData();
    }

    /* --- 消息发送 --- */
    async function sendMessage() {
        if(!activeCharId || !activeSessionId) return;
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if(!text) return;

        const session = appData.chats[activeCharId].sessions[activeSessionId];
        const currentUser = getCurrentUser(); // 获取当前身份

        // User Msg
        const userMsg = { role: 'user', content: text, meta: { time: Date.now(), userName: currentUser.name, userAvatar: currentUser.avatar } };
        session.messages.push(userMsg);
        appendMsgUI(userMsg, true);
        input.value = '';
        saveData();

        if(session.messages.filter(m=>m.role==='user').length === 1) {
            session.name = text.substring(0, 10);
            renderSessionSelect();
        }

        // Build Prompt with Persona
        const char = appData.chars.find(c => c.id === activeCharId);
        let system = `Role: ${char.name}\nDesc: ${char.desc}\nWorld: ${char.world||''}\n`;
        // 关键：注入当前身份信息
        system += `User Name: ${currentUser.name}\nUser Persona: ${currentUser.desc}`;
        
        const msgs = [{role:"system", content:system}, ...session.messages.slice(-15).map(m=>({role:m.role, content:m.content}))];

        const btn = document.querySelector('.send-btn');
        btn.disabled = true;
        document.getElementById('stopBtn').style.display = 'block';
        const aiTempId = Date.now();
        appendMsgUI({role:'assistant', content:'<i class="fas fa-spinner fa-spin"></i>', meta:{time:Date.now()}}, false, aiTempId);
        scrollToBottom();

        abortCtrl = new AbortController();
        let fullReply = "";

        try {
            const res = await fetch(`${appData.settings.apiHost}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${appData.settings.apiKey}` },
                body: JSON.stringify({
                    model: getSelectedModel(),
                    messages: msgs,
                    temperature: parseFloat(appData.settings.temp),
                    stream: appData.settings.stream
                }),
                signal: abortCtrl.signal
            });

            if(!res.ok) throw new Error("API Error");

            if(appData.settings.stream) {
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    const lines = decoder.decode(value).split('\n');
                    for(const line of lines) {
                        if(line.startsWith('data: ')) {
                            try {
                                const delta = JSON.parse(line.slice(6)).choices[0].delta.content || "";
                                fullReply += delta;
                                updateMsgUI(aiTempId, fullReply);
                            } catch(e){}
                        }
                    }
                }
            } else {
                const data = await res.json();
                fullReply = data.choices[0].message.content;
                updateMsgUI(aiTempId, fullReply);
            }

            const tokenEst = Math.floor(fullReply.length / 2);
            const aiMsg = { role: 'assistant', content: fullReply, meta: { time: Date.now(), tokens: tokenEst } };
            session.messages.push(aiMsg);
            saveData();
            updateMsgUI(aiTempId, fullReply, aiMsg.meta);

        } catch(e) {
            if(e.name!=='AbortError') updateMsgUI(aiTempId, "❌ " + e.message);
        } finally {
            btn.disabled = false;
            document.getElementById('stopBtn').style.display = 'none';
            abortCtrl = null;
        }
    }

    /* --- UI 渲染 --- */
    function loadChar(id) {
        activeCharId = id;
        const cData = getCharData(id);
        document.getElementById('topControls').style.display = 'flex';
        if(Object.keys(cData.sessions).length === 0) createNewSession(id, false);
        if(!cData.currentSessionId || !cData.sessions[cData.currentSessionId]) cData.currentSessionId = Object.keys(cData.sessions)[0];
        switchSession(cData.currentSessionId);
        renderCharList();
        if(window.innerWidth <= 768) toggleSidebar();
    }

    function renderChatUI() {
        const container = document.getElementById('chatContainer');
        container.innerHTML = '';
        const session = appData.chats[activeCharId].sessions[activeSessionId];
        session.messages.forEach(m => appendMsgUI(m, m.role === 'user'));
        scrollToBottom();
    }

    function appendMsgUI(msg, isUser, tempId=null) {
        const char = appData.chars.find(c=>c.id===activeCharId);
        // 如果消息里存了当时的用户信息，就用当时的；否则用当前的
        const currentUser = getCurrentUser();
        
        let name, avatar;
        if(isUser) {
            name = msg.meta?.userName || currentUser.name;
            avatar = msg.meta?.userAvatar || currentUser.avatar;
        } else {
            name = char.name;
            avatar = char.avatar;
        }
        
        const div = document.createElement('div');
        div.className = `msg-row ${isUser?'user':'char'}`;
        if(tempId) div.id = `msg-${tempId}`;
        
        const timeStr = new Date(msg.meta?.time || Date.now()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const tokenStr = msg.meta?.tokens ? ` · ~${msg.meta.tokens} tokens` : '';
        
        div.innerHTML = `
            <img class="msg-avatar" src="${avatar||(isUser?DEF_USER_AVATAR:DEF_AVATAR)}" onerror="this.src='${isUser?DEF_USER_AVATAR:DEF_AVATAR}'">
            <div class="msg-body">
                <div style="font-size:0.8rem; color:#aaa; margin-bottom:2px;">${name}</div>
                <div class="msg-bubble">${marked.parse(msg.content)}</div>
                <div class="msg-meta">${timeStr}${tokenStr}</div>
            </div>`;
        document.getElementById('chatContainer').appendChild(div);
    }

    function updateMsgUI(id, content, meta=null) {
        const div = document.getElementById(`msg-${id}`);
        if(div) {
            div.querySelector('.msg-bubble').innerHTML = marked.parse(content);
            if(meta) {
                 const timeStr = new Date(meta.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                 const tokenStr = ` · ~${meta.tokens} tokens`;
                 div.querySelector('.msg-meta').innerHTML = `${timeStr}${tokenStr}`;
            }
            scrollToBottom();
        }
    }

    function renderSessionSelect() {
        const cData = getCharData(activeCharId);
        const sel = document.getElementById('sessionSelect');
        sel.innerHTML = '';
        Object.values(cData.sessions).sort((a,b)=>b.id-a.id).forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id; opt.text = s.name;
            opt.selected = s.id === activeSessionId;
            sel.appendChild(opt);
        });
    }

    /* --- 通用逻辑 (保留 v2 功能) --- */
    function handleModelChange() {
        const val = document.getElementById('modelSelect').value;
        const customInput = document.getElementById('customModelInput');
        customInput.style.display = val === 'custom' ? 'block' : 'none';
        if(val==='custom') customInput.focus();
        saveSettings();
    }
    function getSelectedModel() { const sel = document.getElementById('modelSelect').value; return sel === 'custom' ? document.getElementById('customModelInput').value : sel; }
    
    async function fetchModels() {
        const host = document.getElementById('apiHost').value.replace(/\/v1$/, '');
        const key = document.getElementById('apiKey').value;
        if(!key) return alert("无 Key");
        try {
            const res = await fetch(`${host}/v1/models`, {headers:{Authorization:`Bearer ${key}`}});
            const data = await res.json();
            const sel = document.getElementById('modelSelect');
            sel.innerHTML = ''; 
            data.data.forEach(m => { const opt = document.createElement('option'); opt.value = m.id; opt.text = m.id; sel.appendChild(opt); });
            const cust = document.createElement('option'); cust.value = 'custom'; cust.text = '-- 自定义 --'; sel.appendChild(cust);
            alert(`已更新 ${data.data.length} 个模型`);
        } catch(e) { alert("拉取失败，请使用自定义模式"); }
    }

    function openCharEditor(cid=null) { document.getElementById('charModal').style.display='flex'; if(!cid) { document.getElementById('editId').value=''; document.getElementById('editName').value=''; } }
    function saveChar() {
        const name = document.getElementById('editName').value;
        if(!name) return alert("名字必填");
        const newChar = { id: document.getElementById('editId').value || Date.now().toString(), name: name, avatar: document.getElementById('editAvatar').value, desc: document.getElementById('editDesc').value, world: document.getElementById('editWorld').value, firstMsg: document.getElementById('editFirst').value };
        const idx = appData.chars.findIndex(c=>c.id===newChar.id);
        if(idx >= 0) appData.chars[idx] = newChar; else appData.chars.push(newChar);
        saveData(); renderCharList(); closeModal();
        if(activeCharId===newChar.id) loadChar(newChar.id);
    }
    function deleteChar() {
        const id = document.getElementById('editId').value;
        if(!id||!confirm("确定删除角色？")) return;
        appData.chars = appData.chars.filter(c=>c.id !== id); delete appData.chats[id];
        if(activeCharId === id) { activeCharId = null; document.getElementById('topControls').style.display='none'; document.getElementById('chatContainer').innerHTML='<div style="text-align:center;margin-top:50px;color:#666;">请选择角色</div>'; }
        saveData(); renderCharList(); closeModal();
    }

    function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(appData)); }
    function loadData() {
        const raw = localStorage.getItem(DB_KEY);
        if(raw) {
            const data = JSON.parse(raw);
            appData = {...appData, ...data};
            document.getElementById('apiHost').value = appData.settings.apiHost;
            document.getElementById('apiKey').value = appData.settings.apiKey;
            document.getElementById('temperature').value = appData.settings.temp;
            document.getElementById('tempDisplay').innerText = appData.settings.temp;
            document.getElementById('streamToggle').checked = appData.settings.stream;
            // Model restore logic (same as v2)
            const savedModel = appData.settings.model;
            const sel = document.getElementById('modelSelect');
            if(![...sel.options].some(o=>o.value===savedModel)) { sel.value = 'custom'; document.getElementById('customModelInput').style.display='block'; document.getElementById('customModelInput').value = savedModel; } else { sel.value = savedModel; }
        }
    }
    function saveSettings() { appData.settings.apiHost=document.getElementById('apiHost').value; appData.settings.apiKey=document.getElementById('apiKey').value; appData.settings.model=getSelectedModel(); appData.settings.temp=document.getElementById('temperature').value; appData.settings.stream=document.getElementById('streamToggle').checked; appData.settings.bgUrl=document.getElementById('bgUrl').value; saveData(); }
    function switchTab(t) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); event.currentTarget.classList.add('active'); }
    function renderCharList() { const list = document.getElementById('charList'); list.innerHTML=''; appData.chars.forEach(c=>{ const div=document.createElement('div'); div.className=`list-item ${c.id===activeCharId?'active':''}`; div.innerHTML=`<img src="${c.avatar||DEF_AVATAR}" class="avatar-sm"><div>${c.name}</div><i class="fas fa-cog" style="margin-left:auto;color:#666" onclick="event.stopPropagation();document.getElementById('editId').value='${c.id}';document.getElementById('editName').value='${c.name}';document.getElementById('editAvatar').value='${c.avatar}';document.getElementById('editDesc').value='${c.desc.replace(/\n/g,'\\n')}';document.getElementById('editWorld').value='${(c.world||'').replace(/\n/g,'\\n')}';document.getElementById('editFirst').value='${c.firstMsg.replace(/\n/g,'\\n')}';openCharEditor('${c.id}')"></i>`; div.onclick=()=>loadChar(c.id); list.appendChild(div); }); }
    function handleEnter(e) { if(e.ctrlKey && e.key === 'Enter') sendMessage(); }
    function updateBg() { if(appData.settings.bgUrl) document.body.style.backgroundImage = `url('${appData.settings.bgUrl}')`; }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('mobileOverlay').classList.toggle('active'); }
    function closeModal() { document.getElementById('charModal').style.display='none'; }
    function stopGen() { if(abortCtrl) abortCtrl.abort(); }
    function forkSession() { if(activeCharId&&activeSessionId) { const oldS = getCharData(activeCharId).sessions[activeSessionId]; const newId=Date.now().toString(); getCharData(activeCharId).sessions[newId]={...JSON.parse(JSON.stringify(oldS)), id:newId, name:oldS.name+"(分支)"}; switchSession(newId); } }
    function nukeData() { if(confirm("Clear All?")) { localStorage.clear(); location.reload(); } }
    function scrollToBottom() { const c=document.getElementById('chatContainer'); c.scrollTop=c.scrollHeight; }
</script>
</body>
</html>
